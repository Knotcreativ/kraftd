name: Deploy infra to Staging (manual)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "YES" to confirm running this deploy workflow'
        required: true
        default: 'NO'
      resource_group:
        description: 'Resource group name to create or use'
        required: true
        default: 'kraftd-staging-rg'
      location:
        description: 'Azure location to deploy to'
        required: true
        default: 'eastus2'
      prefix:
        description: 'Resource name prefix'
        required: true
        default: 'kraftd-staging'

jobs:
  deploy:
    if: github.event.inputs.confirm == 'YES'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure CLI login (service principal)
        run: |
          echo "Logging in to Azure using service principal credentials..."
          az login --service-principal -u "${{ secrets.AZURE_CLIENT_ID }}" -p "${{ secrets.AZURE_CLIENT_SECRET }}" --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Verify Azure Login
        run: |
          echo "Checking signed-in account..."
          az account show --query "{name:name, id:id, tenantId:tenantId}" -o json

      - name: Run infra deployment script (PowerShell)
        env:
          AZURE_ENV: 'staging'
        run: |
          pwsh -NoProfile -NonInteractive -Command "./infrastructure/azure/deploy_function_infra.ps1 -rgName ${{ github.event.inputs.resource_group }} -location ${{ github.event.inputs.location }} -prefix ${{ github.event.inputs.prefix }}"

      - name: Output instructions
        run: |
          echo "Deployment script completed. Verify resources and role assignments in the Azure Portal."

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Notify
        run: echo "Staging infra deploy workflow finished. Check run logs for details." 
